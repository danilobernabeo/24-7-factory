<!--
  CHUNK MODX: contactFormAjax - VERSIONE FIXED

  Fix: Aggiunto marker nascosto per rilevare successo correttamente
  Fix: ID spostato su wrapper per anchor link header funzionante
-->

<div class="form-block-2 w-form" id="contact-form">

   <!-- Marker nascosto per AJAX - indica successo -->
   [[!+fi.successMessage:notempty=`
      <input type="hidden" id="formit-success-marker" value="1">
   `]]

   <!-- Messaggio di Successo (nascosto di default) -->
   <div id="success-message" class="success-message-ajax" style="display: none;">
      <p style="font-size: 18px; color: #155724; margin-top: 0; margin-bottom: 10px;"><strong>We've Received Your Message</strong></p>
      <p style="font-size: 16px; line-height: 1.6; margin-bottom: 0;">
         Thank you for reaching out. We're already reviewing your request and someone from our team will get back to you within 24 hours.
      </p>
   </div>

   <!-- Messaggio Errore Generale (nascosto di default) -->
   <div id="error-message-general" class="error-message-ajax" style="display: none;">
      <strong>Something needs your attention:</strong> <span id="error-message-text"></span>
   </div>

   <!-- Form -->
   <form id="contact-form-element" name="contact-form" class="contact-form-inner">

      <h2 class="bottom-margin---m">Message</h2>

      <div class="w-layout-grid contact-form-grid">

         <!-- First Name -->
         <div class="form-field-wrapper">
            <label for="firstName" class="faq-question">
               First name <span style="color: #BF0A0B;">*</span>
            </label>
            <input
               class="form-field w-input"
               maxlength="256"
               name="firstName"
               placeholder="Enter your first name"
               type="text"
               id="firstName"
               required
               minlength="2"
            >
            <span class="error-text" id="error-firstName" style="display: none;">[[!+fi.error.firstName]]</span>
         </div>

         <!-- Last Name -->
         <div class="form-field-wrapper">
            <label for="lastName" class="faq-question">
               Last name <span style="color: #BF0A0B;">*</span>
            </label>
            <input
               class="form-field w-input"
               maxlength="256"
               name="lastName"
               placeholder="Enter your last name"
               type="text"
               id="lastName"
               required
               minlength="2"
            >
            <span class="error-text" id="error-lastName" style="display: none;">[[!+fi.error.lastName]]</span>
         </div>

         <!-- Email -->
         <div class="form-field-wrapper">
            <label for="email" class="faq-question">
               Email Address <span style="color: #BF0A0B;">*</span>
            </label>
            <input
               class="form-field w-input"
               maxlength="256"
               name="email"
               placeholder="Enter your email"
               type="email"
               id="email"
               required
            >
            <span class="error-text" id="error-email" style="display: none;">[[!+fi.error.email]]</span>
         </div>

         <!-- Phone -->
         <div class="form-field-wrapper">
            <label for="phone" class="faq-question">
               Phone <span style="color: #BF0A0B;">*</span>
            </label>
            <input
               class="form-field w-input"
               maxlength="256"
               name="phone"
               placeholder="Enter your phone number"
               type="tel"
               id="phone"
               required
               minlength="8"
            >
            <span class="error-text" id="error-phone" style="display: none;">[[!+fi.error.phone]]</span>
         </div>

         <!-- Message -->
         <div id="w-node-_4682a8f6-484a-d420-654a-14140757e660-26fc9b40" class="form-field-wrapper">
            <label for="message" class="faq-question">
               Message <span style="color: #BF0A0B;">*</span>
            </label>
            <textarea
               id="message"
               name="message"
               maxlength="5000"
               placeholder="Write your message"
               class="form-field w-input"
               required
               minlength="10"
            ></textarea>
            <span class="error-text" id="error-message" style="display: none;">[[!+fi.error.message]]</span>
         </div>

      </div>

      <!-- Submit Button -->
      <button
         type="submit"
         id="submit-button"
         class="secondary-button form-button w-button"
      >
         <span id="button-text">Submit</span>
         <span id="button-loading" style="display: none;">Sending...</span>
      </button>

   </form>

</div>

<!-- CSS -->
<style>
.field-error {
   border-color: #BF0A0B !important;
   background-color: #fff5f5 !important;
}

.error-text {
   color: #BF0A0B;
   font-size: 0.875rem;
   margin-top: 5px;
   display: block;
}

.success-message-ajax {
   background-color: #d4edda;
   border: 2px solid #28a745;
   color: #155724;
   padding: 30px;
   margin-bottom: 30px;
   border-radius: 8px;
   text-align: center;
   animation: slideDown 0.5s ease-out;
}

.error-message-ajax {
   background-color: #f8d7da;
   border: 2px solid #BF0A0B;
   color: #721c24;
   padding: 20px;
   margin-bottom: 20px;
   border-radius: 8px;
   animation: shake 0.5s ease-out;
}

@keyframes slideDown {
   from {
      opacity: 0;
      transform: translateY(-20px);
   }
   to {
      opacity: 1;
      transform: translateY(0);
   }
}

@keyframes shake {
   0%, 100% { transform: translateX(0); }
   25% { transform: translateX(-10px); }
   75% { transform: translateX(10px); }
}

#submit-button:disabled {
   opacity: 0.6;
   cursor: not-allowed;
}

@keyframes spin {
   to { transform: rotate(360deg); }
}

.spinner {
   display: inline-block;
   width: 14px;
   height: 14px;
   border: 2px solid rgba(255,255,255,0.3);
   border-top-color: #fff;
   border-radius: 50%;
   animation: spin 0.6s linear infinite;
   margin-left: 8px;
   vertical-align: middle;
}
</style>

<!-- JavaScript AJAX FIXED -->
<script>
(function() {
   'use strict';

   var form = document.getElementById('contact-form-element');
   var submitButton = document.getElementById('submit-button');
   var buttonText = document.getElementById('button-text');
   var buttonLoading = document.getElementById('button-loading');
   var successMessage = document.getElementById('success-message');
   var errorMessageGeneral = document.getElementById('error-message-general');
   var errorMessageText = document.getElementById('error-message-text');

   function showFieldError(fieldName, message) {
      var field = document.getElementById(fieldName);
      var errorSpan = document.getElementById('error-' + fieldName);

      if (field && errorSpan && message.trim() !== '') {
         field.classList.add('field-error');
         errorSpan.textContent = message;
         errorSpan.style.display = 'block';
      }
   }

   function clearErrors() {
      var fields = ['firstName', 'lastName', 'email', 'phone', 'message'];
      fields.forEach(function(fieldName) {
         var field = document.getElementById(fieldName);
         var errorSpan = document.getElementById('error-' + fieldName);

         if (field) field.classList.remove('field-error');
         if (errorSpan) {
            errorSpan.textContent = '';
            errorSpan.style.display = 'none';
         }
      });

      errorMessageGeneral.style.display = 'none';
   }

   form.addEventListener('submit', function(e) {
      e.preventDefault();

      clearErrors();

      // Loading state
      submitButton.disabled = true;
      buttonText.style.display = 'none';
      buttonLoading.style.display = 'inline';
      buttonLoading.innerHTML = 'Sending... <span class="spinner"></span>';

      var formData = new FormData(form);
      formData.append('submit-contact', '1');

      fetch(window.location.href, {
         method: 'POST',
         body: formData,
         headers: {
            'X-Requested-With': 'XMLHttpRequest'
         }
      })
      .then(function(response) {
         return response.text();
      })
      .then(function(html) {
         var parser = new DOMParser();
         var doc = parser.parseFromString(html, 'text/html');

         // METODO 1: Cerca il marker nascosto di successo
         var successMarker = doc.getElementById('formit-success-marker');

         if (successMarker) {
            // SUCCESSO!
            console.log('FormIt Success detected');

            // Nascondi form
            form.style.display = 'none';

            // Mostra messaggio successo
            successMessage.style.display = 'block';

            // Scroll al messaggio (ora punta a #contact-form che Ã¨ il wrapper)
            setTimeout(function() {
               successMessage.scrollIntoView({
                  behavior: 'smooth',
                  block: 'center'
               });
            }, 100);

         } else {
            // ERRORI - Cerca errori nei placeholder FormIt
            console.log('Checking for FormIt errors');

            var hasErrors = false;
            var errorFields = ['firstName', 'lastName', 'email', 'phone', 'message'];

            errorFields.forEach(function(fieldName) {
               var errorSpan = doc.getElementById('error-' + fieldName);
               if (errorSpan) {
                  var errorText = errorSpan.textContent.trim();

                  // Controlla se contiene placeholder non espanso
                  if (errorText && !errorText.includes('[[!+fi.error.')) {
                     hasErrors = true;
                     showFieldError(fieldName, errorText);
                     console.log('Error found for field: ' + fieldName + ' - ' + errorText);
                  }
               }
            });

            if (hasErrors) {
               errorMessageText.textContent = 'Please check the highlighted fields below and try again.';
               errorMessageGeneral.style.display = 'block';

               // Scroll al primo errore
               setTimeout(function() {
                  var firstError = document.querySelector('.field-error');
                  if (firstError) {
                     firstError.scrollIntoView({
                        behavior: 'smooth',
                        block: 'center'
                     });
                  }
               }, 100);
            } else {
               // Nessun marker successo E nessun errore trovato = problema
               console.warn('No success marker and no errors found');
               errorMessageText.textContent = 'Hmm, something unexpected happened. We\'re not sure what went wrong, but we\'re on it. Please try again in a few moments.';
               errorMessageGeneral.style.display = 'block';
            }
         }
      })
      .catch(function(error) {
         console.error('AJAX Error:', error);
         errorMessageText.textContent = 'We couldn\'t send your message. Please check your connection and try again.';
         errorMessageGeneral.style.display = 'block';
      })
      .finally(function() {
         // Reset loading state
         submitButton.disabled = false;
         buttonText.style.display = 'inline';
         buttonLoading.style.display = 'none';
      });
   });

   // Validazione real-time
   var inputs = form.querySelectorAll('input, textarea');
   inputs.forEach(function(input) {
      input.addEventListener('blur', function() {
         var errorSpan = document.getElementById('error-' + this.id);
         if (this.validity.valid) {
            this.classList.remove('field-error');
            if (errorSpan) errorSpan.style.display = 'none';
         }
      });
   });

})();
</script>
